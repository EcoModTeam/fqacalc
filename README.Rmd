---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# fqacalc

## A Floristic Quality Assessment Calculator for R

<!-- badges: start -->
<!-- badges: end -->

This package provides functions for calculating Floristic Quality Assessment (FQA) metrics using regional Floristic Quality Assessment Index (FQAI) databases that have been approved by the US Army Corps of Engineers. 

## Installation

You can install the development version of `fqacalc` from [GitHub](https://github.com/) with:

``` r
# install.packages("devtools")
devtools::install_github("ifoxfoot/fqacalc")
```

```{r}
#attach packages required for this tutorial
library(fqacalc) #for FQA 
library(stringr) #for string manipulation
library(dplyr) #for data manipulation
library(readxl) #for reading in excel files
```

## Package Data

`fqacalc` contains all regional FQAI databases that have been either fully approved or approved with reservations for use by the US Army Corps of Engineers. By referencing these databases, the package can assign Coefficients of Conservatism (or C Value) to each plant that the user inputs. A list of regional FQAI databases can be viewed using the `db_names()` function, and specific FQA databases can be accessed using the `view_db()` function. 

```{r}
#view a list of all available databases
head(db_names())

#store the Colorado database as an object
colorado <- view_db("colorado_2020")

#view it
head(colorado)
```

`fqacalc` also comes with a site assessment from Crooked Island, Michigan, downloaded from the [Universal FQA Calculator](https://universalfqa.org/). The data set is called `crooked_island` and can be used to demonstrate how the package works.

```{r}
#take a look at crooked island's plants
head(crooked_island)

#view at the documentation for the data (bottom right pane of R studio)
?crooked_island

#load the data set into local environment
crooked_island <- crooked_island
```

## Reading Site Assessment Data into R

Site assessments can be read into R for analysis using base R or the `readxl` package (for .xls or .xlsx files).

If the site assessment is a csv file, it can be read in using `read.csv()`. For example, code to read in data might look like `my_data <- read.csv("path/to/my/data.csv")`. If the site assessment is in an Excel file, it can be read in with the same code, but replace `read.csv()` with `read_excel()`.

In order to calculate FQA metrics using `fqacalc`, the site assessment data must be in a certain format. 

1. The data should have either a column named `name` containing Latin names of plants, or a column named `acronym` containing acronyms of plants. Different regional FQA databases use different naming conventions and have different ways of creating acronyms (and some don't have acronyms!) so be sure to look at the regional database to check that the site assessment is using the same conventions. Names/acronyms do not have to be in the same case, but otherwise must be exactly the same as their counterpart in the regional FQAI database in order to be recognized by `fqacalc` functions. 

2. If the user is calculating cover-weighted metrics, the data must have another column containing cover values and it must be called `cover`. If the cover values are in percent cover, they must be between 0-100. If they are in a class, they must be correct for that class or else they won't be recognized. See the section on cover-weighted functions to learn more about cover classes.

3. If the user is calculation plot metrics, the data must have another column containing the plot ID. In this case, each observation is one row, containing the species name or acronym, the cover value, and the plot ID.

It might looks something like this:

```{r, echo = F}
data <- data.frame(plot_id = c(1, 1, 2, 2),
                   name = c("Plant A", "Plant B", "Plant C", "Plant D"),
                   cover = c(20, 50, 35, 45))

kableExtra::kable(data)
```


## Functions that Match Plants from Site Assessments to Regional FQA Databases

`fqacalc` contains two functions that help the user understand how the data they input relates to the regional database: `accepted_entries()` and `unassigned_plants()`. `accepted_entries()` is a function that shows which plants in the input data frame are successfully matched to plants in the regional database, and `unassigned_plants()` shows which species are matched but don't have a C value stored in the regional database.

### What happens when a plant is not in the regional FQA database?

`accepted_enteries` shows which species are recognized, but it also provides warnings when a species is not recognized. To demonstrate this we can add a mistake to the `crooked_island` data set.

```{r}
#introduce a typo
mistake_island <- crooked_island %>% 
  mutate(name = str_replace(name, "Abies balsamea", "Abies blahblah"))

#store accepted entries
accepted_entries <- accepted_entries(#this is the data
                                     mistake_island, 
                                     #'key' to join the data to regional list
                                     key = "name", 
                                     #this is the regional list
                                     db = "michigan_2014", 
                                     #include native AND non-native entries
                                     native = F) 
```

Now, when we use `accepted_entries()` to see which species were matched to the regional dataset, we can see that we recieved a message about the species 'ABIES BLAHBLAH' being discarded and we can also see that the accepted entries dataset we created only has 34 entries instead of the expected 35 entries.

### What happens when plants don't have C values?

In some cases, plants from the user list can be matched to the regional database, but the plant is not associated with any C Value. This is usually because not enough is known about that plant. Plants that are matched but have no C Value will be excluded from FQI metric calculation but they can *optionally* be included in other metrics like species richness, relative cover, relative frequency, relative importance, and mean wetness, as well as any summarizing functions containing these metrics. This option is denoted with the `allow_no_c` argument. 

`unassigned_plants()` is a function that shows the user which plants have not been assigned a C Value.

```{r}
#To see unassigned_plants in action we're going to Montana! 

#first create a df of plants to input
no_c_plants<- data.frame(name = c("ABRONIA FRAGRANS", 
                                  "ACER GLABRUM", 
                                  "ACER GRANDIDENTATUM", 
                                  "ACER PLATANOIDES"))

#then create a df of unassigned plants
unassigned_plants(no_c_plants, key = "name", db = "montana_2017")

```

Two of these species have no C Values.

### How will duplicates be treated?

If the site assessment data contains duplicate species, they will be excluded from certain FQA metrics. For example, species richness counts the number of unique species so duplicates are not allowed. Generally, duplicates are excluded for all non-cover-weighted metrics but can optionally be included in cover-weighted metrics unless they are in the same plot. Duplicate behavior in cover-weighted functions is controlled by the `allow_duplicates` argument. If there are duplicates, and the user is attempting to preform a cover-weighted calculation where duplicates are not allowed, the they will be condensed into one species with an aggregate cover value. Duplicates can always be included in all frequency metrics. 

If there is a duplicate species and `allow_duplicates = FALSE`, a message will warn the user that the duplicate will be removed. See this example.

```{r}
#write a dataframe with duplicates
transect <- data.frame(acronym  = c("ABEESC", "ABIBAL", "AMMBRE", 
                                    "ANTELE", "ABEESC", "ABIBAL", "AMMBRE"),
                      cover = c(50, 4, 20, 30, 40, 7, 60),
                      quad_id = c(1, 1, 1, 1, 2, 2, 2))

#set allow_duplicates to FALSE
cover_FQI(transect, key = "acronym", db = "michigan_2014", native = FALSE, allow_duplicates = FALSE)
```

### Will synonyms be recognized?

Some regional FQA databases include accepted scientific names as well as commonly used synonyms. As long as these synonyms are in the regional database, they will be recognized by `fqacalc` functions. There are a few important rules regarding synonyms. 

1. If both the synonym and the accepted name are used in a site assessment, the synonym will be converted to the accepted name and both observations will only count as *one* species.

2. Similarly, if the site assessment data contains a name that is listed as a synonym to one species and an accepted name to a different species, it will default to the accepted name.

3. If the site assessment contains a species that is listed as a synonym to multiple species in the regional FQA database, this entry will *not* be included! To include the species, enter the accepted scientific name instead of the synonym.

In all of these cases, `fqacalc` functions will print messages to warn the user about synonym issues. See this example:

```{r}
#df where some entries are listed as main name, and synonym of another species
synonyms <- data.frame(name = c("CAREX FOENEA", "ABIES BIFOLIA"),
                       cover = c(60, 10))

mean_c(synonyms, key = "name", db = "wyoming_2017", native = F)
```


## Unweighted FQI Metrics

`fqacalc` also contains a variety of functions that calculate Total Species Richness, Native Species Richness, Mean C, Native Mean C, Total FQI, Native FQI, and Adjusted FQI. All of these functions eliminate duplicate species and species that cannot be found in the regional database. All but Total Species Richness automatically eliminate species that are not associated with a C Value.

#### Function Arguments

All of the metric functions have the same arguments (and two don't have the native argument)

* **x**: A data frame containing a list of plant species. This data frame *must* have one of the following columns: `scientific_name` or `acronym`. 

* **key**: A character string representing the column that will be used to join the input `x` with the regional FQA database. If a value is not specified the default is `name`. `name` and `acronym` are the only acceptable values for key.

* **db**: A character string representing the regional FQA database to use. See `db_names()` for a list of potential values.

* **native**: native Boolean (TRUE or FALSE). If TRUE, calculate metrics using only native species.

Additionally, `species_richness()` and `all_metrics()` have an argument called `allow_no_c`. If `allow_no_c = TRUE` than species that are in the regional FQAI database but don't have C Values will be included. If `allow_no_c` is FALSE, then these species will be omitted. This argument is also found in `mean_w()` and all of the relative functions. 

#### Functions

```{r}
#total mean c
mean_c(crooked_island, key = "acronym", db = "michigan_2014", native = FALSE)

#native mean C
mean_c(crooked_island, key = "acronym", db = "michigan_2014", native = TRUE)

#total FQI
FQI(crooked_island, key = "acronym", db = "michigan_2014", native = FALSE)

#native FQI
FQI(crooked_island, key = "acronym", db = "michigan_2014", native = TRUE)

#adjusted FQI (always includes both natives and non-natives)
adjusted_FQI(crooked_island, key = "acronym", db = "michigan_2014")
```

And finally, `all_metrics()` prints all of the metrics in a data frame format.

```{r}
all_metrics(crooked_island, key = "acronym", db = "michigan_2014")
```

All of the functions are documented with help pages.

```{r}
?all_metrics
```

## Cover-Weighted Functions

Cover-Weighted Functions calculate the same metrics but they are weighted by how abundant each species is. Therefore, the input data frame must also have a column named `cover` containing cover values. Cover values can be continuous (i.e. percent cover) or classed (i.e. using the Braun-Blanquet method).

The following tables describe how cover classes are converted to percent cover. Internally, cover-weighted functions convert cover classes to the percent cover midpoint, which reduces accuracy. Therefore using percent cover is recommended over using cover classes.

| Braun-Blanquet Classes | \% Cover Range | Midpoint |
|------------------------|----------------|----------|
| \+                     | \<1%           | 0.1      |
| 1                      | \<5%           | 2.5      |
| 2                      | 5-25%          | 15       |
| 3                      | 25-50%         | 37.5     |
| 4                      | 50-75%         | 62.5     |
| 4                      | 75-100%        | 87.5     |

| Carolina Veg Survey Classes | \% Cover Range | Midpoint |
|-----------------------------|----------------|----------|
| 1                           | \<0.1          | 0.1      |
| 2                           | 0-1%           | 0.5      |
| 3                           | 1-2%           | 1.5      |
| 4                           | 2-5%           | 3.5      |
| 5                           | 5-10%          | 7.5      |
| 6                           | 10-25%         | 17.5     |
| 7                           | 25-50%         | 37.5     |
| 8                           | 50-75%         | 62.5     |
| 9                           | 75-95%         | 85       |
| 10                          | 95-100%        | 97.5     |

| Daubenmire Classes | \% Cover Range | Midpoint |
|--------------------|----------------|----------|
| 1                  | 0-5%           | 2.5      |
| 2                  | 5-25%          | 15       |
| 3                  | 25-50%         | 37.5     |
| 4                  | 50-75%         | 62.5     |
| 5                  | 75-95%         | 85       |
| 6                  | 95-100%        | 97.5     |

| USFS Ecodata Classes | \% Cover Range | Midpoint |
|----------------------|----------------|----------|
| 1                    | \<1%           | 0.5      |
| 3                    | 1.1-5%         | 3        |
| 10                   | 5.1-15%        | 10       |
| 20                   | 15.1-25%       | 20       |
| 30                   | 25.1-35%       | 30       |
| 40                   | 35.1-45%       | 40       |
| 50                   | 45.1-55%       | 50       |
| 60                   | 55.1-65%       | 60       |
| 70                   | 65.1-75%       | 70       |
| 80                   | 75.1-85%       | 80       |
| 90                   | 85.1-95%       | 90       |
| 98                   | 95.1-100%      | 98       |

Cover-Weighted Functions come in two flavors: those that allow duplicate entries and those that don't. Not allowing duplicate species observations works best for calculating plot-level metrics, where each species is counted once along with its total cover value. Allowing duplicates work best for transect-level metrics, where repeated plots along a transect may contain the same species. As a note, if `allow_duplicates = FALSE` in a cover-weighted function, any duplicated species will be counted once and their cover values will be added together.

Even if duplicate species are allowed, if a plot id column is indicated using the `plot_id` argument then duplicated species in the same plots will only be counted once and their cover values will be added together.

#### Function Arguments

Cover-Weighted Functions have a few additional arguments: 

* **cover_metric**: A character string representing the cover method used. Acceptable cover methods are: `"percent_cover"`, `"carolina_veg_survey"`, `"braun-blanquet"`, `"doubinmire"`, and `"usfs_ecodata"`. `"percent_cover"` is the default and is recommended because it is the most accurate.

* **allow_duplicates**: Boolean (TRUE or FALSE). If TRUE, allow duplicate entries of the same species. If FALSE, do not allow species duplication. Setting `allow_duplicates` to TRUE is best for calculating metrics for multiple plots/quadrants which potentially contain the same species. Setting `allow_duplicates` to FALSE is best for calculating metrics for a single plot/quadrant, where each species is entered once along with its total cover value.

#### Functions

```{r}
#firstmake a hypothetical plot with cover values
plot <- data.frame(acronym  = c("ABEESC", "ABIBAL", "AMMBRE", "ANTELE"),
                   name = c("Abelmoschus esculentus", 
                            "Abies balsamea", "Ammophila breviligulata", 
                            "Anticlea elegans; zigadenus glaucus"),
                   cover = c(50, 4, 20, 30))

#now make up a transect
transect <- data.frame(acronym  = c("ABEESC", "ABIBAL", "AMMBRE", 
                                    "ANTELE", "ABEESC", "ABIBAL", "AMMBRE"),
                      cover = c(50, 4, 20, 30, 40, 7, 60),
                      quad_id = c(1, 1, 1, 1, 2, 2, 2))

#cover mean c (no duplicates allowed!)
cover_mean_c(plot, key = "acronym", db = "michigan_2014", 
             native = FALSE, cover_metric = "percent_cover", 
             allow_duplicates = FALSE)

#transect mean c (duplicates allowed)
cover_mean_c(transect, key = "acronym", db = "michigan_2014", 
             native = FALSE, cover_metric = "percent_cover",
             allow_duplicates = TRUE)

#cover-weighted FQI (again, you can choose to allow duplicates or not)
cover_FQI(transect, key = "acronym", db = "michigan_2014", native = FALSE, 
          cover_metric = "percent_cover",
          allow_duplicates = TRUE)

#transect summary function (allows duplicates)
transect_summary(transect, key = "acronym", db = "michigan_2014")
```

There is also a plot summary function that summarizes plots along a transect. Data is input as a single data frame containing species per plot. This data frame must also have a column representing the plot that the species was observed in. This column is then passed to an additional argument

* **plot_id**: A character string representing the name of the column in `x` that indicates which plot the species was observed in.

Because it is sometimes useful to calculate the total amount of bare ground or un-vegetated water in a plot, the user can also choose to include bare ground or water. To get this feature to work, the user must set another argument:

* **allow_non_veg**: Boolean (TRUE or FALSE). If TRUE, allow input to contain un-vegetated ground and un-vegetated water.

If `allow_non_veg` is true, the user can include species "UNVEGETATED GROUND" or "UNVEGETATED WATER" along with plant species. They can also use acronyms "GROUND" or "WATER".

```{r}
#print transect to view structure of data
transect_unveg <- data.frame(acronym  = c("GROUND", "ABEESC", "ABIBAL", "AMMBRE",
                                          "ANTELE", "WATER", "GROUND", "ABEESC", 
                                          "ABIBAL", "AMMBRE"),
                             cover = c(60, 50, 4, 20, 30, 20, 20, 40, 7, 60),
                             quad_id = c(1, 1, 1, 1, 1, 2, 2, 2, 2, 2))

#plot summary of a transect (dplicates are not allowed)
plot_summary(x = transect_unveg, key = "acronym", db = "michigan_2014", 
             cover_metric = "percent_cover", 
             plot_id = "quad_id")
```

## Relative Functions

Relative functions calculate relative frequency, coverage, and importance for each category. `fqacalc` also contains a species summary function that produces a summary of each species' relative metrics in a data frame. Relative functions always allow duplicate species observations. They also always allow ground and water to be included.

Relative functions have one additional argument which tells the functions what to calculate the relative value of:

* **col**: A character string equal to 'species', 'family', or 'physiog'. 

Relative functions do not have a native argument.

```{r}
#To calculate the relative value of a tree

#relative frequency
relative_frequency(transect, key = "acronym", db = "michigan_2014", 
              col = "physiog")

#can also include bare ground and water
relative_frequency(transect_unveg, key = "acronym", db = "michigan_2014", 
              col = "physiog")

#relative cover
relative_cover(transect, key = "acronym", db = "michigan_2014", 
               col = "family", cover_metric = "percent_cover")

#relative importance
relative_importance(transect, key = "acronym", db = "michigan_2014", 
                    col = "species", cover_metric = "percent_cover")

#species summary (including ground and water)
species_summary(transect_unveg, key = "acronym", db = "michigan_2014", 
                cover_metric = "percent_cover")

#physiognomy summary (including ground and water)
physiog_summary(transect_unveg, key = "acronym", db = "michigan_2014", 
                cover_metric = "percent_cover")
```

## Wetness metric

`fqacalc` has one wetness metric, which calculates the mean wetness coefficient per site. The wetness coefficient is based off of the Wetland Indicator Status. Negative wetness coefficients indicate a stronger affinity for wetlands, while positive wetland coefficients indicate an affinity for uplands.

```{r}
#mean wetness
mean_w(crooked_island, key = "acronym", db = "michigan_2014")
```

## The End
